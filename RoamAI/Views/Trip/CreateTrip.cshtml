@using RoamAI.Models.Entities
@model Trip

<style>
    body {
        background-image: url('/images/travel6.png');
        background-size: cover;
        background-position: center;
        font-family: Arial, sans-serif;
        color: #333;
        margin: 0;
        padding: 0;
        display: flex;
        align-items: flex-start;
        justify-content: center;
        min-height: 100vh;
    }
    .date-group {
    
    margin: 15px;
    }


    .travel-plan-card {
        background-color: rgba(255, 255, 255, 0.9);
        border-radius: 15px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        padding: 20px;
        width: 700px;
        text-align: center;
        margin-top: 100px;
    }

    .slider-group {
        display: flex;
        align-items: center;
        gap: 15px;
        width: 100%;
        margin-top: 30px;
    }

        .slider-group label {
            font-weight: bold;
            text-align: left;
            flex-basis: 40%;
        }

        .slider-group input[type="range"] {
            flex: 1;
            -webkit-appearance: none;
            height: 6px;
            background: #ddd;
            outline: none;
            opacity: 0.9;
            transition: opacity .2s;
            border-radius: 4px;
        }

            .slider-group input[type="range"]::-webkit-slider-thumb {
                -webkit-appearance: none;
                appearance: none;
                width: 15px;
                height: 15px;
                background: #007bff;
                cursor: pointer;
                border-radius: 50%;
            }

            .slider-group input[type="range"]::-moz-range-thumb {
                width: 15px;
                height: 15px;
                background: #007bff;
                cursor: pointer;
                border-radius: 50%;
            }

    .slider-value {
        width: 40px;
        text-align: right;
    }

    #submitBtn {
        background-color: #007bff;
        color: white;
        border: 2px solid #007bff;
        cursor: pointer;
        transition: background-color 0.3s ease, border 0.3s ease;
        margin: 0 auto;
        width: 50%;
        padding: 15px;
        font-size: 1.1rem;
        display: block;
        border-radius: 8px;
        margin-top: 30px;
    }

    #submitBtn:hover {
        background-color: #0056b3;
        border-color: #0056b3;
    }

    .header {
        background-color: rgba(0, 0, 0, 0.1);
        color: #333;
        padding: 10px 0;
        margin-bottom: 20px;
        border-radius: 8px;
        font-weight: bold;
        width: 100%;
    }
    
    .travel-plan-card h2 {
        margin: 10px;
    }
    #city,#country{
        width:300px;
    }
    .form-group{
        margin:10px;
    }


</style>

<div class="travel-plan-card">
    <div class="header">
        <h2>Travel Planı Oluştur</h2>
    </div>
    <form method="post" asp-action="GetRecommendations" asp-controller="Trip">
        <div class="form-group row mb-3">
            <label class="col-sm-3 col-form-label">Ülke:</label>
            <div class="col-sm-9">
                <select id="country" name="Country" asp-for="Country" class="choices" required>
                    <option value="">Select Country</option>
                </select>
            </div>
        </div>
        <div class="form-group row mb-3">
            <label class="col-sm-3 col-form-label">Şehir:</label>
            <div class="col-sm-9">
                <select id="city" name="City" asp-for="City" required>
                    <option value="">Select City</option>
                </select>
            </div>
        </div>
        <div class="date-group">
            <div class="form-group">
                <label>Gidiş: </label>
                <input type="date" name="StartDate" asp-for="StartDate" required />
            </div>
            <div class="form-group">
                <label>Dönüş: </label>
                <input type="date" name="EndDate" asp-for="EndDate" required />
            </div>
        </div>
        <div class="slider-group">
            <label>Kültürel Gezi:</label>
            <input type="range" name="CulturalPercentage" asp-for="CulturalPercentage" min="0" max="100" value="40" step="10" oninput="document.getElementById('culturalValue').textContent = this.value + '%'">
            <span id="culturalValue" class="slider-value">40%</span>
        </div>

        <div class="slider-group">
            <label>Modern Gezi:</label>
            <input type="range" name="EntertainmantPercentage" asp-for="EntertainmantPercentage" min="0" max="100" value="30" step="10" oninput="document.getElementById('entertainmentValue').textContent = this.value + '%'">
            <span id="entertainmentValue" class="slider-value">30%</span>
        </div>

        <div class="slider-group">
            <label>Yemek Üzerine Gezi:</label>
            <input type="range" name="FoodPercentage" asp-for="FoodPercentage" min="0" max="100" value="30" step="10" oninput="document.getElementById('foodValue').textContent = this.value + '%'">
            <span id="foodValue" class="slider-value">30%</span>
        </div>
        
        <button type="submit" id="submitBtn">Plan Oluştur</button>
    </form>

    @if (Model != null && Model.Locations != null && Model.Locations.Any())
    {
        <h3>Gezilecek Yerler</h3>
        <ul>
            @foreach (var recommendation in Model.Locations)
            {
                <li>@recommendation.LocationName</li>
            }
        </ul>

        <h3>@Model.City hakkında Bilgiler</h3>
        <p>@Model.Description</p> <!-- Şehir hakkında bilgiyi burada gösteriyoruz. -->


        <h3>Harita</h3>
        <div id="map" style="height: 500px; width: 100%;"></div> <!-- Harita burada oluşturulacak -->
        <button id="createMultiStopRoute" style="margin-top: 20px;">Seçili Duraklarla Rota Oluştur</button>
        <button id="resetLocations" style="margin-top: 20px; margin-left: 10px;">Seçimleri Sıfırla</button>

    }
</div>



<div id="recommendations" style="display:none;">
    <h3>Gezilecek Yerler</h3>
    <ul id="locationList"></ul>
    <h3>Şehir Bilgisi</h3>
    <p id="cityInfo"></p>
    <h3>Harita</h3>
    <div id="map" style="height: 500px; width: 100%;"></div>
    <p>Bu seyahat planı başarıyla kaydedildi. <strong>Trip ID:</strong> <span id="tripId"></span></p>
</div>

<!-- Choices.js CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" />

<!-- jQuery CDN -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<!-- Choices.js JS -->
<script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>





<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">

<!-- SweetAlert2 JS -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<!-- Choices.js JS -->
<script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>

<!-- Google Maps API Key ile Script -->

<script src="https://maps.googleapis.com/maps/api/js?key=KEYBURAYA"></script>

<script>
    $(document).ready(function () {
        $('#travelForm').submit(function (e) {
            e.preventDefault();

            // Form verilerini alın
            var formData = $(this).serialize();

            // AJAX ile GetRecommendations metoduna istekte bulunun
            $.ajax({
                url: '@Url.Action("GetRecommendations", "Trip")',
                type: 'POST',
                data: formData,
                success: function (response) {
                    // Öneri alanlarını doldurun
                    $('#recommendations').show();
                    $('#locationList').empty();
                    $('#cityInfo').text(response.cityInfo);
                    $('#tripId').text(response.tripId); // Trip ID'yi göster

                    response.locations.forEach(location => {
                        $('#locationList').append(`<li>${location.LocationName} (${location.Coordinates})</li>`);
                    });

                    // Haritayı güncelleyin
                    initializeMap(response.locations);
                },
                error: function (xhr, status, error) {
                    alert('Bir hata oluştu: ' + error);
                }
            });
        });

        // Harita başlatma fonksiyonu
        function initializeMap(locations) {
            if (locations.length > 0) {
                var firstLocation = locations[0];
                var firstCoords = firstLocation.Coordinates.split(',');
                var map = new google.maps.Map(document.getElementById("map"), {
                    center: { lat: parseFloat(firstCoords[0]), lng: parseFloat(firstCoords[1]) },
                    zoom: 12
                });

                locations.forEach(location => {
                    var coords = location.Coordinates.split(',');
                    var marker = new google.maps.Marker({
                        position: { lat: parseFloat(coords[0]), lng: parseFloat(coords[1]) },
                        map: map,
                        title: location.LocationName
                    });
                });
            }
        }
    });
</script>

<script>
    $(document).ready(function () {
        // ViewBag'den JSON stringini alıp parse ediyoruz
        var locations = JSON.parse('@Html.Raw(ViewBag.LocationCoordinates)'); // JSON formatındaki stringi parse ediyoruz
        var selectedLocations = []; // Seçilen konumları saklayacağımız dizi

        if (locations && Object.keys(locations).length > 0) {
            // İlk lokasyonu alıyoruz
            var firstLocationKey = Object.keys(locations)[0];
            var firstLocationCoords = locations[firstLocationKey].split(',');
            var firstLat = parseFloat(firstLocationCoords[0]);
            var firstLng = parseFloat(firstLocationCoords[1]);

            // Haritayı başlat
            var map = new google.maps.Map(document.getElementById("map"), {
                center: { lat: firstLat, lng: firstLng },
                zoom: 12
            });

            // Her bir konum için marker ekliyoruz
            Object.keys(locations).forEach(function (key) {
                var coords = locations[key].split(',');
                var lat = parseFloat(coords[0]);
                var lng = parseFloat(coords[1]);

                // Marker oluştur
                var marker = new google.maps.Marker({
                    position: { lat: lat, lng: lng },
                    map: map,
                    title: key
                });

                // Bilgi penceresi içeriğini ayarlıyoruz
                var infoContent = `<b>${key}</b><br>
                            <button onclick="addLocation(${lat}, ${lng}, '${key}')">Bu konumu rota duraklarına ekle</button><br>
                            <a href="https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}" target="_blank">Tek Rota Oluştur</a>`;

                var infoWindow = new google.maps.InfoWindow({
                    content: infoContent
                });

                // Marker'a tıklandığında infoWindow açılıyor
                marker.addListener("click", function () {
                    infoWindow.open(map, marker);
                });
            });
        }

        // Konumları dizimize ekleyen fonksiyon
        window.addLocation = function (lat, lng, key) {
            selectedLocations.push({ lat: lat, lng: lng, name: key });
            Swal.fire({
                icon: 'success',
                title: 'Durak Eklendi',
                text: `${key} rota duraklarına eklendi!`,
                timer: 1500,
                showConfirmButton: false
            });
        };

        // Seçili duraklarla çoklu duraklı rota oluşturma
        $('#createMultiStopRoute').on('click', function () {
            if (selectedLocations.length === 0) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Uyarı',
                    text: 'Rota oluşturmak için en az bir konum seçin!',
                });
                return;
            }

            // Google Maps rota URL'sini hazırlıyoruz
            var routeUrl = "https://www.google.com/maps/dir/?api=1";
            routeUrl += `&origin=${selectedLocations[0].lat},${selectedLocations[0].lng}`; // İlk seçilen konum başlangıç noktası
            routeUrl += `&destination=${selectedLocations[selectedLocations.length - 1].lat},${selectedLocations[selectedLocations.length - 1].lng}`; // Son seçilen konum varış noktası

            // Ara durakları ekliyoruz
            if (selectedLocations.length > 2) {
                var waypoints = selectedLocations.slice(1, -1).map(loc => `${loc.lat},${loc.lng}`).join('|');
                routeUrl += `&waypoints=${waypoints}`;
            }

            // Yeni sekmede rota oluşturmak için Google Maps'i açıyoruz
            window.open(routeUrl, '_blank');

            // Seçili durakları sıfırlıyoruz
            selectedLocations = [];
            Swal.fire({
                icon: 'info',
                title: 'Duraklar Sıfırlandı',
                text: 'Seçili duraklar sıfırlandı. Yeni durakları seçebilirsiniz.',
                timer: 1500,
                showConfirmButton: false
            });
        });

        // Seçimleri sıfırlama butonu
        $('#resetLocations').on('click', function () {
            selectedLocations = [];
            Swal.fire({
                icon: 'info',
                title: 'Seçimler Sıfırlandı',
                text: 'Tüm seçimler sıfırlandı.',
                timer: 1500,
                showConfirmButton: false
            });
        });
    });
</script>


<!-- Custom Script -->
<script>
    $(document).ready(function () {
        // Choices.js ülke select kutusuna uygula
        const countrySelect = new Choices('#country', {
            searchEnabled: true,
            placeholderValue: 'Ülke Seçiniz',
            searchPlaceholderValue: 'Aramak için yazın...'
        });

        var citiesData = [];
        $.getJSON('/data/countries.json', function (data) {
            // Ülkeler için seçenekler ekle
            countrySelect.setChoices(data.map(country => ({
                value: country.countryId,
                label: country.name
            })), 'value', 'label', true);
        }).fail(function () {
            console.error('Failed to load countries.json');
        });

        $.getJSON('/data/cities.json', function (data) {
            citiesData = data; // Şehir verilerini depola
        }).fail(function () {
            console.error('Failed to load cities.json');
        });

        $('#country').change(function () {
            var selectedCountryId = $(this).val();
            var $citySelect = $('#city');
            $citySelect.empty(); // Önceki şehirleri temizle
            $citySelect.append($('<option>', { value: '', text: 'Select City' }));

            if (selectedCountryId) {
                var filteredCities = citiesData.filter(function (city) {
                    return city.countryId === selectedCountryId;
                });

                // Şehirleri select kutusuna ekle
                $.each(filteredCities, function (index, city) {
                    $citySelect.append($('<option>', {
                        value: city.id,
                        text: city.name
                    }));
                });
            }
        });

        // Yüzde kontrolü: Toplam %100 olmalı
        $('#submitBtn').click(function (e) {
            var cultural = parseInt($('input[name="CulturalPercentage"]').val(), 10) || 0;
            var modern = parseInt($('input[name="EntertainmantPercentage"]').val(), 10) || 0;
            var food = parseInt($('input[name="FoodPercentage"]').val(), 10) || 0;
            var total = cultural + modern + food;

            if (total !== 100) {
                e.preventDefault(); // Formun gönderilmesini engelle
                alert('Gezi türü yüzdelerinin toplamı 100 olmalıdır!');
            }
        });
    });
</script>
