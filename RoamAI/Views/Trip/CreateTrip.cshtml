@using RoamAI.Models.Entities
@model Trip

<div>
    <h2>Travel Planı Oluştur</h2>
    <form method="post" asp-action="GetRecommendations" asp-controller="Trip">
        <label>Ülke: </label>
        <select id="country" name="Country" asp-for="Country" class="choices" required>
            <option value="">Select Country</option>
        </select>
        <br />

        <label>Şehir: </label>
        <select id="city" name="City" asp-for="City" required>
            <option value="">Select City</option>
        </select>
        <br />

        <label>Gideceğiniz Tarih: </label>
        <input type="date" name="StartDate" asp-for="StartDate" required />
        <br />

        <label>Döneceğiniz Tarih: </label>
        <input type="date" name="EndDate" asp-for="EndDate" required />
        <br />

        <label>Kültürel Gezi Yüzdesi: </label>
        <input type="number" name="CulturalPercentage" asp-for="CulturalPercentage" required min="0" max="100" value="40" />
        <br />

        <label>Modern Gezi Yüzdesi: </label>
        <input type="number" name="EntertainmantPercentage" asp-for="EntertainmantPercentage" required min="0" max="100" value="30" />
        <br />

        <label>Yemek Üzerine Gezi Yüzdesi: </label>
        <input type="number" name="FoodPercentage" asp-for="FoodPercentage" required min="0" max="100" value="30" />
        <br />

        <button type="submit" id="submitBtn">Plan Oluştur</button>
    </form>

    @if (Model != null && Model.Locations != null && Model.Locations.Any())
    {
        <h3>Gezilecek Yerler</h3>
        <ul>
            @foreach (var recommendation in Model.Locations)
            {
                <li>@recommendation.LocationName</li>
            }
        </ul>

        <h3>@Model.City hakkında Bilgiler</h3>
        <p>@Model.Description</p> <!-- Şehir hakkında bilgiyi burada gösteriyoruz. -->


        <h3>Harita</h3>
        <div id="map" style="height: 500px; width: 100%;"></div> <!-- Harita burada oluşturulacak -->
        <button id="createMultiStopRoute" style="margin-top: 20px;">Seçili Duraklarla Rota Oluştur</button>
        <button id="resetLocations" style="margin-top: 20px; margin-left: 10px;">Seçimleri Sıfırla</button>

    }
</div>

<!-- Choices.js CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" />

<!-- jQuery CDN -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<!-- Choices.js JS -->
<script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>





<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">

<!-- SweetAlert2 JS -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<!-- Choices.js JS -->
<script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>

<!-- Google Maps API Key ile Script -->

<!-- Buraya key yapistir. -->


<script>
    $(document).ready(function () {
        // ViewBag'den JSON stringini alıp parse ediyoruz
        var locations = JSON.parse('@Html.Raw(ViewBag.LocationCoordinates)'); // JSON formatındaki stringi parse ediyoruz
        var selectedLocations = []; // Seçilen konumları saklayacağımız dizi

        if (locations && Object.keys(locations).length > 0) {
            // İlk lokasyonu alıyoruz
            var firstLocationKey = Object.keys(locations)[0];
            var firstLocationCoords = locations[firstLocationKey].split(',');
            var firstLat = parseFloat(firstLocationCoords[0]);
            var firstLng = parseFloat(firstLocationCoords[1]);

            // Haritayı başlat
            var map = new google.maps.Map(document.getElementById("map"), {
                center: { lat: firstLat, lng: firstLng },
                zoom: 12
            });

            // Her bir konum için marker ekliyoruz
            Object.keys(locations).forEach(function (key) {
                var coords = locations[key].split(',');
                var lat = parseFloat(coords[0]);
                var lng = parseFloat(coords[1]);

                // Marker oluştur
                var marker = new google.maps.Marker({
                    position: { lat: lat, lng: lng },
                    map: map,
                    title: key
                });

                // Bilgi penceresi içeriğini ayarlıyoruz
                var infoContent = `<b>${key}</b><br>
                            <button onclick="addLocation(${lat}, ${lng}, '${key}')">Bu konumu rota duraklarına ekle</button><br>
                            <a href="https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}" target="_blank">Tek Rota Oluştur</a>`;

                var infoWindow = new google.maps.InfoWindow({
                    content: infoContent
                });

                // Marker'a tıklandığında infoWindow açılıyor
                marker.addListener("click", function () {
                    infoWindow.open(map, marker);
                });
            });
        }

        // Konumları dizimize ekleyen fonksiyon
        window.addLocation = function (lat, lng, key) {
            selectedLocations.push({ lat: lat, lng: lng, name: key });
            Swal.fire({
                icon: 'success',
                title: 'Durak Eklendi',
                text: `${key} rota duraklarına eklendi!`,
                timer: 1500,
                showConfirmButton: false
            });
        };

        // Seçili duraklarla çoklu duraklı rota oluşturma
        $('#createMultiStopRoute').on('click', function () {
            if (selectedLocations.length === 0) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Uyarı',
                    text: 'Rota oluşturmak için en az bir konum seçin!',
                });
                return;
            }

            // Google Maps rota URL'sini hazırlıyoruz
            var routeUrl = "https://www.google.com/maps/dir/?api=1";
            routeUrl += `&origin=${selectedLocations[0].lat},${selectedLocations[0].lng}`; // İlk seçilen konum başlangıç noktası
            routeUrl += `&destination=${selectedLocations[selectedLocations.length - 1].lat},${selectedLocations[selectedLocations.length - 1].lng}`; // Son seçilen konum varış noktası

            // Ara durakları ekliyoruz
            if (selectedLocations.length > 2) {
                var waypoints = selectedLocations.slice(1, -1).map(loc => `${loc.lat},${loc.lng}`).join('|');
                routeUrl += `&waypoints=${waypoints}`;
            }

            // Yeni sekmede rota oluşturmak için Google Maps'i açıyoruz
            window.open(routeUrl, '_blank');

            // Seçili durakları sıfırlıyoruz
            selectedLocations = [];
            Swal.fire({
                icon: 'info',
                title: 'Duraklar Sıfırlandı',
                text: 'Seçili duraklar sıfırlandı. Yeni durakları seçebilirsiniz.',
                timer: 1500,
                showConfirmButton: false
            });
        });

        // Seçimleri sıfırlama butonu
        $('#resetLocations').on('click', function () {
            selectedLocations = [];
            Swal.fire({
                icon: 'info',
                title: 'Seçimler Sıfırlandı',
                text: 'Tüm seçimler sıfırlandı.',
                timer: 1500,
                showConfirmButton: false
            });
        });
    });
</script>


<!-- Custom Script -->
<script>
    $(document).ready(function () {
        // Choices.js ülke select kutusuna uygula
        const countrySelect = new Choices('#country', {
            searchEnabled: true,
            placeholderValue: 'Ülke Seçiniz',
            searchPlaceholderValue: 'Aramak için yazın...'
        });

        var citiesData = [];
        $.getJSON('/data/countries.json', function (data) {
            // Ülkeler için seçenekler ekle
            countrySelect.setChoices(data.map(country => ({
                value: country.countryId,
                label: country.name
            })), 'value', 'label', true);
        }).fail(function () {
            console.error('Failed to load countries.json');
        });

        $.getJSON('/data/cities.json', function (data) {
            citiesData = data; // Şehir verilerini depola
        }).fail(function () {
            console.error('Failed to load cities.json');
        });

        $('#country').change(function () {
            var selectedCountryId = $(this).val();
            var $citySelect = $('#city');
            $citySelect.empty(); // Önceki şehirleri temizle
            $citySelect.append($('<option>', { value: '', text: 'Select City' }));

            if (selectedCountryId) {
                var filteredCities = citiesData.filter(function (city) {
                    return city.countryId === selectedCountryId;
                });

                // Şehirleri select kutusuna ekle
                $.each(filteredCities, function (index, city) {
                    $citySelect.append($('<option>', {
                        value: city.id,
                        text: city.name
                    }));
                });
            }
        });

        // Yüzde kontrolü: Toplam %100 olmalı
        $('#submitBtn').click(function (e) {
            var cultural = parseInt($('input[name="CulturalPercentage"]').val(), 10) || 0;
            var modern = parseInt($('input[name="EntertainmantPercentage"]').val(), 10) || 0;
            var food = parseInt($('input[name="FoodPercentage"]').val(), 10) || 0;
            var total = cultural + modern + food;

            if (total !== 100) {
                e.preventDefault(); // Formun gönderilmesini engelle
                alert('Gezi türü yüzdelerinin toplamı 100 olmalıdır!');
            }
        });
    });
</script>
